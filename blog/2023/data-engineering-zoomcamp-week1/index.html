<!DOCTYPE html> <html lang="en"> <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://kamalpatell.github.io/"><span class="font-weight-bold">Kamal</span> Patel</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/"> About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/"> Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/"> Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/"> Repositories</a> </li> <li class="nav-item "> <a class="nav-link" target="_blank" href="/assets/pdf/resume.pdf">Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h2 class="post-title">Data Engineering Week 1 - Docker and Postgresql</h2> <p class="post-meta"> November 7, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/data-engineering"> <i class="fas fa-hashtag fa-sm"></i> data-engineering</a>     ·   <a href="/blog/category/data"> <i class="fas fa-tag fa-sm"></i> data</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"><ul id="toc" class="section-nav"> <li class="toc-entry toc-h3"><a href="#docker-and-postgres">Docker and Postgres</a></li> <li class="toc-entry toc-h3"><a href="#docker-command">Docker command</a></li> <li class="toc-entry toc-h3"><a href="#terraform--google-cloud-platform">Terraform + Google Cloud Platform</a></li> </ul></div> <hr> <div id="markdown-content"> <p>The Data Engineering Zoomcamp is a 7 week data engineering course. It offers free instruction on the most widely used technologies and tools in data engineering and the cloud. During week 1, participants learns to build a data pipeline and retrieve and ingest data using Docker, Postgres, Docker-compose, Terraform and Google Cloud. Key topics covered in week 1 include: Docker, Postgres, Docker-compose, Terraform, Google Cloud, and Google VM.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/blog/data/de-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/blog/data/de-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/blog/data/de-1400.webp"></source> <img src="/assets/img/blog/data/de.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Data Engineering Pipeline </div> <h3 id="docker-and-postgres">Docker and Postgres</h3> <p><strong>Introduction of the Docker</strong></p> <p>Docker is an open-source platform that allows developer to easily create, deploy and run applications in containers. Containers are lightweight portable and self suffcient environments that allow applications to run consistently across different environment.</p> <p><strong>Introduction of Postgres</strong></p> <p>Postgres is a versatile database that is designed for transactional purposes rather than analytics. Despite this, it is powerful and sometimes employed as a data warehouse solution.</p> <h3 id="docker-command">Docker command</h3> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run hello-world

<span class="c"># -it: run iterative mode</span>

docker run <span class="nt">-it</span> ubuntu bash <span class="se">\</span>
docker run <span class="nt">-it</span> python:3.9 <span class="se">\</span>
docker run <span class="nt">-it</span> <span class="nt">--entrypoint</span><span class="o">=</span>bash python:3.9<span class="sb">`</span>

<span class="c"># build an image called taxi-ingest:v001</span>

docker build <span class="nt">-t</span> taxi-ingest:v001 <span class="nb">.</span>
docker run <span class="nt">-it</span> <span class="nb">test</span>:pandas<span class="sb">`</span>
</code></pre></div></div> <p><strong>Ingesting data into the database</strong></p> <p>Once you have created this Dockerfile, you can build the image by running the command docker build -t mypostgres . and then run it with docker run -p 5432:5432 mypostgres. This will start the container and map port 5432 on the host to port 5432 in the container. Dockerfile</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FROM</span> <span class="n">python</span><span class="p">:</span><span class="mf">3.9</span><span class="p">.</span><span class="mi">1</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">wget</span>
<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">pandas</span> <span class="n">sqlalchemy</span> <span class="n">psycopg2</span>

<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">app</span>
<span class="n">COPY</span> <span class="n">ingest_data</span><span class="p">.</span><span class="n">py</span> <span class="n">ingest_data</span><span class="p">.</span><span class="n">py</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span> <span class="sh">"</span><span class="s">python</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ingest_data.py</span><span class="sh">"</span> <span class="p">]</span>

</code></pre></div></div> <p>By running the above commands, your dataset will be loaded and ready for use in the postgres container.</p> <p><strong>Running Postgres locally with Docker</strong></p> <p><code class="language-plaintext highlighter-rouge">docker run -it \ -e POSTGRES_USER="root" \ -e POSTGRES_PASSWORD="root" \ -e POSTGRES_DB="ny_taxi" \ -v "$(pwd)/ny_taxi_postgres_data:/var/lib/postgresql/data"\ -p 5432:5432 \ postgres:13</code></p> <p>To interact with Postgres in command line we can install <a href="https://www.pgcli.com/install" rel="external nofollow noopener" target="_blank">pgcli</a>.</p> <p><strong>Install pgcli with pip</strong></p> <p><code class="language-plaintext highlighter-rouge">pip install pgcli</code></p> <p><strong>Connect with the postgres</strong></p> <p><code class="language-plaintext highlighter-rouge">pgcli -h localhost -p 5432 -u root -d ny_taxi</code></p> <p><strong>Check with tables</strong></p> <p><code class="language-plaintext highlighter-rouge">\dt</code></p> <p><strong>Jupyter Notebook</strong></p> <p>we will import yellow trip taxi data from nyc taxi website and read the data as iteration in chunks to insert into the sql database.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># read the data with pandas
</span><span class="n">df_iter</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">./yellow_tripdata_2021-07.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">iterator</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># used next(iter object) to iterate through chunks
</span><span class="n">df</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">df_iter</span><span class="p">)</span>

<span class="c1"># convert pick and drop time into datetime objects
</span><span class="n">df</span><span class="p">.</span><span class="n">tpep_pickup_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">tpep_pickup_datetime</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">tpep_dropoff_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">tpep_dropoff_datetime</span><span class="p">)</span>

<span class="c1"># insert to sql
</span><span class="o">%</span><span class="n">time</span> <span class="n">df</span><span class="p">.</span><span class="nf">to_sql</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">yellow_taxi_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="sh">'</span><span class="s">replace</span><span class="sh">'</span><span class="p">)</span>

<span class="kn">from</span> <span class="n">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">t_start</span> <span class="o">=</span> <span class="nf">time</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">df_iter</span><span class="p">)</span>

    <span class="n">df</span><span class="p">.</span><span class="n">tpep_pickup_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">tpep_pickup_datetime</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">tpep_dropoff_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">tpep_dropoff_datetime</span><span class="p">)</span>

    <span class="n">df</span><span class="p">.</span><span class="nf">to_sql</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sh">'</span><span class="s">yellow_taxi_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="sh">'</span><span class="s">append</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">t_end</span> <span class="o">=</span> <span class="nf">time</span><span class="p">()</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">inserted another chunk..., took %.3f second</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">))</span>
</code></pre></div></div> <p><strong>pgAdmin</strong></p> <ul> <li>It’s not convenient to use pgcli for data exploration and querying. Instead, we will use <a href="https://www.pgadmin.org/" rel="external nofollow noopener" target="_blank">pgAdmin</a>, the standard graphical tool for postgres. We can run it with docker. However, this docker container can’t access the postgres container. We need to link them.</li> </ul> <p><code class="language-plaintext highlighter-rouge">docker run -it \ -e PGADMIN_DEFAULT_EMAIL="admin@admin.com" \ -e PGADMIN_DEFAULT_PASSWORD="root" \ -p 8080:80 \ dpage/pgadmin4</code></p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/blog/data/pgadmin-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/blog/data/pgadmin-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/blog/data/pgadmin-1400.webp"></source> <img src="/assets/img/blog/data/pgadmin.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> pgadmin dashboard </div> <p><strong>Docker Network</strong></p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># To link the database with pgadmin</span>
<span class="c"># Connect a container to a network</span>
docker network create pgnetwork

docker run <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">POSTGRES_USER</span><span class="o">=</span><span class="s2">"root"</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span><span class="s2">"root"</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">POSTGRES_DB</span><span class="o">=</span><span class="s2">"ny_taxi"</span> <span class="se">\</span>
  <span class="nt">-v</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span><span class="s2">/ny_taxi_postgres_data:/var/lib/postgresql/data"</span><span class="se">\</span>
  <span class="nt">-p</span> 5432:5432 <span class="se">\</span>
  <span class="nt">--name</span> pgdatabase <span class="se">\</span>
  <span class="nt">--network</span> pgnetwork <span class="se">\</span>
  postgres:13

docker run <span class="nt">-it</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">PGADMIN_DEFAULT_EMAIL</span><span class="o">=</span><span class="s2">"admin@admin.com"</span> <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">PGADMIN_DEFAULT_PASSWORD</span><span class="o">=</span><span class="s2">"root"</span> <span class="se">\</span>
  <span class="nt">-p</span> 8080:80 <span class="se">\</span>
  <span class="nt">--name</span> pgadmin <span class="se">\</span>
  <span class="nt">--network</span> pgnetwork <span class="se">\</span>
  dpage/pgadmin4

<span class="c"># Ingest data</span>
docker run <span class="nt">-it</span> <span class="se">\</span>
    <span class="nt">--network</span><span class="o">=</span>pgnetwork <span class="se">\</span>
    taxi-ingest:v001 <span class="se">\</span>
        <span class="nt">--user</span><span class="o">=</span>root <span class="se">\</span>
        <span class="nt">--password</span><span class="o">=</span>root <span class="se">\</span>
        <span class="nt">--host</span><span class="o">=</span>pgdatabase <span class="se">\</span>
        <span class="nt">--port</span><span class="o">=</span>5432 <span class="se">\</span>
        <span class="nt">--db</span><span class="o">=</span>ny_taxi <span class="se">\</span>
        <span class="nt">--table_name</span><span class="o">=</span>green_taxi_trips <span class="se">\</span>
        <span class="nt">--url</span><span class="o">=</span><span class="k">${</span><span class="nv">URL</span><span class="k">}</span>

</code></pre></div></div> <p>It works, but we need to keep two terminal tabs running, manually create a network - and a bunch of other things. Let’s use docker compose that will take care of that.</p> <p><strong>Docker-compose</strong></p> <p>Docker Compose is a powerful tool that makes it easy to define and run multi-container Docker applications, simplifying the process of development, testing, and deployment. It allows developers to define all the services and dependencies of an application in a single file, and then start, stop, and manage those services with simple commands. Docker Compose also allows developers to define networks and volumes that can be shared between services. The docker-compose.yml file is a YAML file that defines the services, networks, and volumes needed for the application.</p> <p><strong>Start the application in “detached” mode: the containers run in the background and the terminal is free for other commands.</strong> <code class="language-plaintext highlighter-rouge">docker-compose up -d</code></p> <p><strong>Stop and remove the containers</strong> <code class="language-plaintext highlighter-rouge">docker-compose down</code></p> <p>docker-compose.yml file</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">services</span><span class="pi">:</span>
  <span class="na">pgdatabase</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:13</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_USER=root</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD=root</span>
      <span class="pi">-</span> <span class="s">POSTGRES_DB=ny_taxi</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">./ny_taxi_postgres_data:/var/lib/postgresql/data:rw"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">5432:5432"</span>
  <span class="na">pgadmin</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">dpage/pgadmin4</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">PGADMIN_DEFAULT_EMAIL=admin@admin.com</span>
      <span class="pi">-</span> <span class="s">PGADMIN_DEFAULT_PASSWORD=root</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:80"</span>
</code></pre></div></div> <h3 id="terraform--google-cloud-platform">Terraform + Google Cloud Platform</h3> <p><strong>Terraform</strong></p> <p><a href="https://www.terraform.io/" rel="external nofollow noopener" target="_blank">Terraform</a> is an open-source infrastructure as code software tool that enables you to safely and predictably create, change, and improve infrastructure. First of all, follow the instruction to <a href="https://developer.hashicorp.com/terraform/downloads?ajs_aid=1ddc0b9c-f34a-4de4-8a92-f83ddc38f58b&amp;product_intent=terraform" rel="external nofollow noopener" target="_blank">install Terraform</a>.</p> <p>Command:</p> <ol> <li> <code class="language-plaintext highlighter-rouge">terraform init</code>: <ul> <li>Initializes &amp; configures the backend, installs plugins/providers, &amp; checks out an existing configuration from a version control</li> </ul> </li> <li> <code class="language-plaintext highlighter-rouge">terraform plan</code>: <ul> <li>Matches/previews local changes against a remote state, and proposes an Execution Plan.</li> </ul> </li> <li> <code class="language-plaintext highlighter-rouge">terraform apply</code>: <ul> <li>Asks for approval to the proposed plan, and applies changes to cloud</li> </ul> </li> <li> <code class="language-plaintext highlighter-rouge">terraform destroy</code> <ul> <li>Removes your stack from the Cloud</li> </ul> </li> </ol> <p><strong>Google Account</strong></p> <p>Step 1: Create a new google account and get free 300€.</p> <p>Step 2: Create a new project.</p> <p>Step 3: Create a service account</p> <ul> <li>Assign the role as Viewer.</li> <li>Create and download the key.</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/blog/data/gcp-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/blog/data/gcp-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/blog/data/gcp-1400.webp"></source> <img src="/assets/img/blog/data/gcp.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Google Cloud Platform </div> <p><strong>Install Google SDK</strong></p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ ./google-cloud-sdk/install.sh
<span class="c">#Welcome to the Google Cloud CLI!</span>

~ gcloud init

<span class="nb">export </span><span class="nv">GOOGLE_APPLICATION_CREDENTIALS</span><span class="o">=</span><span class="s2">"&lt;path/to/your/service-account-authkeys&gt;.json"</span>

<span class="c"># Refresh token/session, and verify authentication</span>
gcloud auth application-default login
</code></pre></div></div> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0" style="text-align: center;"> © Copyright 2025 Kamal Patel. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>